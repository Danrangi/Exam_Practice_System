<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JAMB War Room</title>
    <link href="{{ url_for('static', filename='vendor/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/css/all.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/base.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/jamb.css') }}" rel="stylesheet">
</head>
<body>
    <form method="POST" id="examForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <header class="war-room-header shadow-sm">
            <div class="subject-tabs-header">
                {% for subject_name in exam_data.keys() %}
                <button type="button" 
                        class="tab-btn {% if loop.first %}active{% endif %}" 
                        onclick="switchTab({{ loop.index }}, this)"
                        id="tab-btn-{{ loop.index }}">
                    {{ subject_name }}
                </button>
                {% endfor %}
            </div>

            <div class="d-flex align-items-center gap-3">
                <button type="button" class="btn btn-light border btn-sm" onclick="toggleCalc()" title="Calculator">
                    <i class="fas fa-calculator text-primary"></i>
                </button>
                <div class="user-passport" title="Candidate Identity">
                    <i class="fas fa-user fa-lg"></i>
                </div>
                <div class="d-none d-md-block">
                    <div class="fw-bold small text-uppercase text-muted" style="font-size: 0.7rem;">Candidate</div>
                    <div class="fw-bold small">{{ g.user }}</div>
                </div>
            </div>

            <div class="d-flex align-items-center gap-3">
                <div id="timer" class="timer-display shadow-inner">02:00:00</div>
                <button type="button" class="btn btn-danger px-3 fw-bold" onclick="openAlert()">
                    Submit
                </button>
            </div>
        </header>

        <div class="war-room-container">
            <div class="main-stage">
                <div class="tab-content h-100">
                    {% for subject_name, questions in exam_data.items() %}
                    {% set subject_index = loop.index %}
                    <div class="tab-pane fade h-100 {% if loop.first %}show active{% endif %}" id="content-{{ subject_index }}">
                        <div class="h-100" style="overflow-y: auto; padding-bottom: 80px;" id="scroll-{{ subject_index }}">
                            {% if questions %}
                                {% for q in questions %}
                                <div class="question-block mb-5" id="q-{{ subject_index }}-{{ loop.index }}">
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="badge bg-secondary me-2 rounded-pill">Question {{ loop.index }}</span>
                                    </div>
                                    <div class="question-text">{{ q.question_text }}</div>
                                    <div class="options-list">
                                        <div class="option-card" onclick="selectOption('q_{{ q.id }}', 'A', this, {{ subject_index }}, {{ loop.index }})">
                                            <input type="radio" name="q_{{ q.id }}" value="A" class="d-none">
                                            <span class="fw-bold me-3 text-muted">A.</span> {{ q.option_a }}
                                        </div>
                                        <div class="option-card" onclick="selectOption('q_{{ q.id }}', 'B', this, {{ subject_index }}, {{ loop.index }})">
                                            <input type="radio" name="q_{{ q.id }}" value="B" class="d-none">
                                            <span class="fw-bold me-3 text-muted">B.</span> {{ q.option_b }}
                                        </div>
                                        <div class="option-card" onclick="selectOption('q_{{ q.id }}', 'C', this, {{ subject_index }}, {{ loop.index }})">
                                            <input type="radio" name="q_{{ q.id }}" value="C" class="d-none">
                                            <span class="fw-bold me-3 text-muted">C.</span> {{ q.option_c }}
                                        </div>
                                        <div class="option-card" onclick="selectOption('q_{{ q.id }}', 'D', this, {{ subject_index }}, {{ loop.index }})">
                                            <input type="radio" name="q_{{ q.id }}" value="D" class="d-none">
                                            <span class="fw-bold me-3 text-muted">D.</span> {{ q.option_d }}
                                        </div>
                                    </div>
                                </div>
                                <hr class="border-light my-5">
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted mt-5">No questions loaded.</div>
                            {% endif %}
                        </div>
                        <div class="position-fixed bottom-0 start-0 bg-white border-top p-3 d-flex justify-content-between align-items-center" style="width: calc(100% - 320px); z-index: 40;">
                            <button type="button" class="btn btn-outline-secondary px-4" onclick="navQuestion(-1)">
                                <i class="fas fa-arrow-left me-2"></i> Previous (P)
                            </button>
                            <button type="button" class="btn btn-success px-5" onclick="navQuestion(1)">
                                Next (N) <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="nav-map">
                <div class="map-header">Question Map</div>
                <div class="grid-container">
                    {% for subject_name, questions in exam_data.items() %}
                    {% set subject_index = loop.index %}
                    <div class="question-grid subject-palette {% if not loop.first %}d-none{% endif %}" id="palette-{{ subject_index }}">
                        {% for q in questions %}
                        <a href="javascript:void(0)" 
                           onclick="scrollToQuestion({{ subject_index }}, {{ loop.index }})"
                           class="grid-btn" 
                           id="btn-{{ subject_index }}-{{ loop.index }}">
                            {{ loop.index }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                <div class="p-3 border-top bg-white small text-muted">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-square text-success"></i> Answered</span>
                        <span><i class="far fa-square"></i> Unanswered</span>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="calc-modal" id="calculator">
        <input type="text" class="calc-display" id="calcDisplay" readonly>
        <div class="calc-keys">
            <button class="calc-btn clr" onclick="calcClear()">C</button>
            <button class="calc-btn op" onclick="calcAppend('/')">/</button>
            <button class="calc-btn op" onclick="calcAppend('*')">*</button>
            <button class="calc-btn op" onclick="calcAppend('-')">-</button>
            <button class="calc-btn" onclick="calcAppend('7')">7</button>
            <button class="calc-btn" onclick="calcAppend('8')">8</button>
            <button class="calc-btn" onclick="calcAppend('9')">9</button>
            <button class="calc-btn op" onclick="calcAppend('+')">+</button>
            <button class="calc-btn" onclick="calcAppend('4')">4</button>
            <button class="calc-btn" onclick="calcAppend('5')">5</button>
            <button class="calc-btn" onclick="calcAppend('6')">6</button>
            <button class="calc-btn eq" onclick="calcSolve()">=</button>
            <button class="calc-btn" onclick="calcAppend('1')">1</button>
            <button class="calc-btn" onclick="calcAppend('2')">2</button>
            <button class="calc-btn" onclick="calcAppend('3')">3</button>
            <button class="calc-btn" onclick="calcAppend('0')">0</button>
        </div>
    </div>

    <div id="sysAlert" class="sys-modal-overlay">
        <div class="sys-modal-box">
            <div class="sys-icon text-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="sys-title">Submit Examination?</div>
            <div class="sys-msg">You are about to end your exam session. Ensure you have attempted all questions.</div>
            <div class="sys-actions">
                <button class="btn-sys cancel" onclick="closeAlert()">Cancel</button>
                <button class="btn-sys confirm" onclick="finalSubmit()">Yes, Submit</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='vendor/js/bootstrap.bundle.min.js') }}"></script>
    <script>
        function openAlert() { document.getElementById('sysAlert').classList.add('active'); }
        function closeAlert() { document.getElementById('sysAlert').classList.remove('active'); }
        function finalSubmit() { document.getElementById('examForm').submit(); }

        function selectOption(inputName, value, card, subjectIndex, questionIndex) {
            const radio = card.querySelector('input[type="radio"]');
            radio.checked = true;
            const container = card.parentElement;
            container.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            const btn = document.getElementById(`btn-${subjectIndex}-${questionIndex}`);
            if(btn) btn.classList.add('answered');
        }

        let currentSubjectIdx = 1;
        function switchTab(index, btn) {
            currentSubjectIdx = index;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
            document.getElementById(`content-${index}`).classList.add('show', 'active');
            document.querySelectorAll('.question-grid').forEach(g => g.classList.add('d-none'));
            document.getElementById(`palette-${index}`).classList.remove('d-none');
        }

        function scrollToQuestion(subjectIdx, questionIdx) {
            const el = document.getElementById(`q-${subjectIdx}-${questionIdx}`);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        function navQuestion(direction) {
            const container = document.getElementById(`scroll-${currentSubjectIdx}`);
            container.scrollBy({ top: direction * 400, behavior: 'smooth' });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key.toLowerCase() === 'n') navQuestion(1);
            if (e.key.toLowerCase() === 'p') navQuestion(-1);
        });

        let totalSeconds = 120 * 60; 
        const timerElem = document.getElementById('timer');
        setInterval(() => {
            if (totalSeconds <= 0) { finalSubmit(); return; }
            if (totalSeconds < 300) timerElem.classList.add('danger');
            let h = Math.floor(totalSeconds / 3600);
            let m = Math.floor((totalSeconds % 3600) / 60);
            let s = totalSeconds % 60;
            timerElem.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            totalSeconds--;
        }, 1000);

        function toggleCalc() {
            const modal = document.getElementById('calculator');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }
        function calcAppend(val) { document.getElementById('calcDisplay').value += val; }
        function calcClear() { document.getElementById('calcDisplay').value = ''; }
        function calcSolve() {
            try { document.getElementById('calcDisplay').value = eval(document.getElementById('calcDisplay').value); }
            catch { document.getElementById('calcDisplay').value = 'Error'; }
        }
    </script>
</body>
</html>
